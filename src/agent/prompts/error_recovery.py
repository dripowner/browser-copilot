"""Стратегии восстановления после ошибок."""

ERROR_RECOVERY_GUIDE = """## Стратегии восстановления после ошибок

### Частые ошибки и решения

**"TimeoutError on browserType.connectOverCDP" или "CDP connection failed"**
→ MCP сервер не может подключиться к браузеру через Chrome DevTools Protocol
→ ЭТО ТЕХНИЧЕСКАЯ ПРОБЛЕМА КОНФИГУРАЦИИ, НЕ проблема установки браузера!
→ Решение:
  - Сообщи пользователю: "Не могу подключиться к браузеру. Проверьте что Edge запущен с флагом --remote-debugging-port=9222 и MCP сервер работает"
  - НЕ вызывай browser_install - браузер установлен, проблема в подключении
  - Останови выполнение и попроси пользователя перезапустить MCP сервер

**"Ref not found in the current page snapshot"**
→ Страница изменилась, refs устарели
→ Решение: browser_snapshot() → найди элемент → повтори с новым ref

**Network timeout / медленная загрузка**
→ Дай странице время загрузиться
→ Решение: Подожди 2-3 секунды, browser_snapshot(), проверь загрузку

**Element not interactive**
→ Элемент существует но не кликабелен (перекрыт, отключен)
→ Решение: Проверь snapshot для альтернативного подхода (другой элемент)

**Authentication required**
→ Защищенный ресурс требует авторизации
→ Решение: Сообщи пользователю, без учетных данных продолжить нельзя

**Dynamic content not appearing**
→ JavaScript требует времени для рендеринга
→ Решение: browser_snapshot() снова через 2-3 секунды

### Playwright API Errors

**TimeoutError: waiting for locator / Timeout exceeded**
→ Элемент не появился в течение timeout (по умолчанию 30 секунд)
→ Причина: Неточный селектор, страница не загрузилась, элемент не рендерится
→ Решение:
  1. Проверить что селектор корректный - попробовать более общий локатор
  2. Увеличить timeout: `await page.getByRole('button').click({ timeout: 60000 })`
  3. Использовать более надежный локатор (getByRole вместо CSS селектора)
  4. Проверить загрузку страницы: `await page.waitForLoadState('networkidle')`

**Error: page.context is not a function**
→ Неправильное использование Playwright API
→ Причина: Забыты круглые скобки при вызове метода
→ Решение:
  1. Использовать `page.context()` с круглыми скобками
  2. Проверить что page передан корректно в async функцию

**Error: Element is not visible / Element is outside of the viewport**
→ Элемент существует но скрыт или находится вне видимой области
→ Причина: Элемент перекрыт другими элементами, скрыт CSS, вне viewport
→ Решение:
  1. Скроллить к элементу: `await element.scrollIntoViewIfNeeded()`
  2. Проверить что элемент не перекрыт overlay или модальным окном
  3. Использовать `{ force: true }` только если уверен: `await element.click({ force: true })`
  4. Попробовать альтернативный элемент для взаимодействия

**Error: Cannot read property 'textContent' of null**
→ Элемент не найден, locator вернул null
→ Причина: Селектор не нашел элемент на странице
→ Решение:
  1. Проверить существование перед доступом: `const count = await locator.count(); if (count === 0) throw Error(...)`
  2. Использовать безопасный доступ: `const text = (await locator.textContent()) || 'default value'`
  3. Попробовать более общий селектор
  4. Проверить что страница загружена и элемент должен быть виден

**Error: Execution context was destroyed**
→ Страница была перезагружена или закрыта во время выполнения
→ Причина: Навигация произошла во время асинхронной операции
→ Решение:
  1. Использовать `waitForNavigation()` при ожидаемых переходах
  2. Повторить операцию на новой странице
  3. Проверить что работаете с актуальной страницей через `page.context().pages()`

### Общий паттерн восстановления

1. **Проанализируй сообщение об ошибке** - пойми что не сработало
2. **Получи свежий контекст** - browser_snapshot() для текущего состояния
3. **Попробуй альтернативу** - другой элемент, другой подход
4. **Сообщи пользователю** - если не можешь восстановиться автоматически, объясни и спроси

### Когда сдаться

После 3 неудачных попыток одного и того же действия:
- Сообщи пользователю о проблеме
- Предложи ручное вмешательство если нужно
- Спроси стоит ли пробовать другой подход
"""
